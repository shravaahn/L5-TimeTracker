<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClickUp Time Tracker</title>
    <style>
        body { font-family: system-ui, sans-serif; display: grid; place-content: center; height: 100vh; background: #1a1a1a; margin: 0; color: white; text-align: center; }
        .login-btn { font-size: 18px; background: #7b68ee; color: white; padding: 14px 24px; border-radius: 8px; border: none; cursor: pointer; text-decoration: none; display: inline-block; }
        .hidden { display: none; }
        #appView p { max-width: 400px; margin: 10px auto; }
        #taskList { list-style: none; padding: 0; max-width: 500px; margin: 20px auto; }
        #taskList li { background: #2a2a2a; padding: 12px; border-radius: 6px; margin-bottom: 8px; }
    </style>
</head>
<body>
    <div id="loginView">
        <a href="#" id="loginButton" class="login-btn">Login with ClickUp</a>
    </div>

    <div id="appView" class="hidden">
        <h1 id="welcomeMessage">Login Successful!</h1>
        <p id="statusText">We have your access token.</p>
        <ul id="taskList"></ul>
    </div>

    <script>
        // --- CONFIGURATION ---
        const CLIENT_ID = '6JL5V3OXV2EZ426G9WH3G2SHSD1YZ43B';
        const REDIRECT_URI = 'https://l5-time-tracker.vercel.app'; // Use your correct Vercel URL

        // --- DOM ELEMENTS ---
        const loginView = document.getElementById('loginView');
        const appView = document.getElementById('appView');
        const loginButton = document.getElementById('loginButton');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const statusText = document.getElementById('statusText');
        const taskList = document.getElementById('taskList');

        // --- AUTHENTICATION & API LOGIC ---

        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const authCode = urlParams.get('code');
            const accessToken = localStorage.getItem('clickup_access_token');

            if (accessToken) {
                loginView.classList.add('hidden');
                appView.classList.remove('hidden');
                fetchData(accessToken);
            } else if (authCode) {
                loginView.classList.add('hidden');
                appView.classList.remove('hidden');
                getAccessToken(authCode);
            }
        };

        loginButton.onclick = function() {
            const authUrl = `https://app.clickup.com/api?client_id=${CLIENT_ID}&redirect_uri=${REDIRECT_URI}`;
            window.location.href = authUrl;
        };

        async function getAccessToken(code) {
            try {
                statusText.textContent = 'Authenticating...';
                const response = await fetch('/api/get_token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code }),
                });

                if (!response.ok) throw new Error('Failed to get access token');
                
                const data = await response.json();
                localStorage.setItem('clickup_access_token', data.accessToken);
                window.history.replaceState({}, document.title, window.location.pathname);
                fetchData(data.accessToken);

            } catch (error) {
                console.error('Error:', error);
                statusText.textContent = `Error: Could not get access token.`;
            }
        }

        async function fetchData(token) {
            try {
                statusText.textContent = 'Fetching your data...';
                
                // Call our NEW secure helper function, passing the token in the header
                const response = await fetch('/api/get_data', {
                    headers: { 'Authorization': token }
                });

                if (!response.ok) {
                    const errorInfo = await response.json();
                    throw new Error(errorInfo.error || 'Failed to fetch data from our server');
                }

                const data = await response.json();
                
                welcomeMessage.textContent = `Welcome, ${data.username}!`;
                statusText.textContent = `Found ${data.tasks.length} assigned tasks in ${data.teamName}.`;

                taskList.innerHTML = '';
                data.tasks.forEach(task => {
                    const listItem = document.createElement('li');
                    listItem.textContent = task.name;
                    taskList.appendChild(listItem);
                });

            } catch (error) {
                console.error('Error fetching data:', error);
                statusText.textContent = `Error: ${error.message}`;
            }
        }
    </script>
</body>
</html>