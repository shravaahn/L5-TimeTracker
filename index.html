<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Time Tracking — v8</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f1115; --panel:#171a21; --muted:#8b94a7; --text:#e8ecf1;
      --accent:#4f8cff; --accent-2:#22c55e; --warn:#f59e0b; --danger:#ef4444;
      --border:#242a35; --input:#11141a; --good:#22c55e; --bad:#ef4444;
      --radius:12px;
    }
    *{box-sizing:border-box}
    body{ margin:0; font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
      color:var(--text); background:linear-gradient(180deg,#0f1115,#0b0d12 60%);
      min-height:100vh; display:flex; align-items:center; justify-content:center; padding:24px; }
    .card{ width:min(1300px,100%); background:var(--panel); border:1px solid var(--border);
      border-radius:var(--radius); box-shadow:0 10px 30px rgba(0,0,0,.35); overflow:hidden; }
    header{ padding:18px 22px; display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid var(--border); background:rgba(255,255,255,.02); }
    .brand{display:flex; gap:10px; align-items:center}
    .logo{ width:34px; height:34px; display:grid; place-items:center; border-radius:10px;
      background:linear-gradient(135deg,var(--accent),#7aa8ff); color:white; font-weight:800; }
    .muted{color:var(--muted)}
    .role-badge{ font-size:12px; padding:6px 10px; border:1px solid var(--border);
      border-radius:999px; color:var(--muted); background:rgba(255,255,255,.02); }
    .wrap{padding:22px}
    .controls{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    button{ appearance:none; border:1px solid var(--border); background:#11141a; color:var(--text);
      padding:10px 14px; border-radius:10px; cursor:pointer; }
    button.primary{background:var(--accent); border-color:transparent; color:white; font-weight:600}
    button.success{background:var(--accent-2); border-color:transparent; color:#06240f; font-weight:600}
    button.warn{background:var(--warn); border-color:transparent; color:#1b1404; font-weight:600}
    button.ghost{background:transparent}
    button:disabled{opacity:.6; cursor:not-allowed}
    input, select{ width:100%; background:var(--input); border:1px solid var(--border); color:var(--text);
      border-radius:10px; padding:10px 12px; outline:none; }
    input[disabled].locked{ background:rgba(79,140,255,.08); border-color:rgba(79,140,255,.35); color:#bcd2ff; }
    .grid{ overflow:auto; border:1px solid var(--border); border-radius:12px; margin-top:14px; }
    table{border-collapse:separate; border-spacing:0; width:100%;}
    thead th{ position:sticky; top:0; z-index:2; background:#12151c; color:#c8d2e3;
      border-bottom:1px solid var(--border); text-align:left; font-weight:600; padding:12px; white-space:nowrap; }
    th, td{border-bottom:1px solid var(--border); padding:10px; vertical-align:middle; white-space:nowrap}
    tbody tr:nth-child(even){background:rgba(255,255,255,.02)}
    tfoot td{background:#10131a; color:#d7dfef; font-weight:600}
    .proj-cell{min-width:220px; position:sticky; left:0; background:inherit; z-index:3}
    .num{text-align:right}
    .tiny{font-size:12px; color:var(--muted)}
    .pill{ font-size:12px; padding:4px 8px; border:1px solid var(--border); border-radius:999px; color:#cbd5e1; background:#0f131a; }
    .linklike{color:#7aa8ff; cursor:pointer; text-decoration:underline}
    .dash{display:grid; grid-template-columns:repeat(3, minmax(0,1fr)); gap:12px; margin-top:16px;}
    .kpi{background:#0f131a; border:1px solid var(--border); border-radius:12px; padding:14px;}
    .kpi .label{font-size:12px; color:var(--muted); margin-bottom:6px}
    .kpi .value{font-size:22px; font-weight:700}
    .kpi.delta.positive .value{color:var(--good)}
    .kpi.delta.negative .value{color:var(--bad)}
    .chartbox{margin-top:12px; background:#0f131a; border:1px solid var(--border); border-radius:12px; padding:12px; overflow:auto;}
    canvas{width:100%; height:220px}
    .pickerRow{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:8px}
    .label{font-size:12px; color:var(--muted)}
    .togglegrp{display:flex; gap:6px; align-items:center}
    .cellBox{display:grid; grid-template-columns:1fr 1fr; gap:6px}

    /* MODAL */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center;
      z-index:10;
    }
    .modal{
      width:min(520px, 92vw); background:#0f131a; border:1px solid var(--border); border-radius:14px; padding:18px;
      box-shadow:0 20px 60px rgba(0,0,0,.6);
    }
    .modal header{ display:flex; align-items:center; justify-content:space-between; padding:0 0 10px 0; border:0; }
    .modal h3{ margin:0; font-size:18px }
    .modal .row{ display:grid; gap:8px; margin:12px 0 }
    .modal .row.two{ grid-template-columns:1fr 1fr; }
    .modal footer{ display:flex; gap:10px; justify-content:flex-end; margin-top:8px }
    .help{ font-size:12px; color:var(--muted) }
    .badge{ display:inline-flex; font-size:11px; padding:2px 8px; border:1px solid var(--border); border-radius:999px; color:#cbd5e1 }
  </style>
</head>
<body>

<!-- LOGIN VIEW -->
<div id="loginView" class="login" hidden>
  <div class="brand" style="margin-bottom:14px">
    <div class="logo">TT</div>
    <div>
      <div style="font-weight:700">Weekly Time Tracking</div>
      <div class="muted">Demo login</div>
    </div>
  </div>
  <h2>Sign in</h2>
  <div class="tiny">Use demo accounts below or create a local one.</div>
  <div style="display:grid; gap:10px; margin-top:12px">
    <label>Username <input id="username" placeholder="e.g., consultant" /></label>
    <label>Password <input id="password" type="password" placeholder="••••••" /></label>
    <label>Role
      <select id="role">
        <option value="consultant">Consultant</option>
        <option value="admin">Admin</option>
      </select>
    </label>
    <button id="loginBtn" class="primary">Continue</button>
  </div>
  <div class="tiny" style="margin-top:8px">Demo: consultant/demo · admin/admin</div>
</div>

<!-- APP VIEW -->
<div id="app" class="card" hidden>
  <header>
    <div class="brand">
      <div class="logo">TT</div>
      <div>
        <div style="font-weight:800">Time Tracking</div>
        <div class="muted" id="weekLabel"></div>
      </div>
    </div>
    <div class="controls">
      <span id="userBadge" class="role-badge"></span>
      <span id="viewingBadge" class="role-badge" style="display:none"></span>
      <button id="prevWeek" class="ghost">◀ Prev</button>
      <button id="thisWeek" class="ghost" title="Jump to current week">This Week</button>
      <button id="nextWeek" class="ghost">Next ▶</button>
      <button id="addRow" class="">+ Add Project</button>
      <button id="saveAll" class="success">Save</button>
      <button id="exportCsv" class="">Export CSV</button>
      <button id="logout" class="warn">Log out</button>
    </div>
  </header>

  <div class="wrap">
    <!-- Admin selectors -->
    <div id="adminPickerRow" class="pickerRow" style="display:none">
      <span class="label">Month:</span>
      <select id="monthPicker" style="min-width:180px"></select>
      <span class="label">Week:</span>
      <select id="weekPicker" style="min-width:260px"></select>
      <span class="label">Consultant:</span>
      <select id="consultantPicker" style="min-width:220px"></select>
      <span class="tiny" id="consultantCount"></span>
      <span class="right"></span>
      <div class="togglegrp">
        <span class="label">View:</span>
        <button id="viewWeek" class="primary">Week</button>
        <button id="viewMonth" class="ghost">Month</button>
      </div>
    </div>

    <div class="sumbar">
      <span class="pill" id="sumEst">Est: 0.00h</span>
      <span class="pill" id="sumTracked">Tracked: 0.00h</span>
      <span class="pill" id="sumDelta">Δ (Tracked–Est): 0.00h</span>
      <span class="right tiny" id="periodLabel">Period: Week</span>
    </div>

    <div class="grid">
      <table id="timesheet">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
        <tfoot id="tfoot"></tfoot>
      </table>
    </div>

    <!-- Admin dashboard (unchanged visuals) -->
    <div id="adminTools" style="margin-top:12px; display:none">
      <div class="muted" style="margin-bottom:8px">Admin tools:</div>
      <div class="dash">
        <div class="kpi"><div class="label" id="kpiEstLabel">Total Est Hours (Week)</div><div class="value" id="kpiEst">0.00h</div></div>
        <div class="kpi"><div class="label" id="kpiTrackedLabel">Total Tracked Hours (Week)</div><div class="value" id="kpiTracked">0.00h</div></div>
        <div class="kpi delta" id="kpiDeltaBox"><div class="label" id="kpiDeltaTitle">Δ Tracked – Est</div><div class="value" id="kpiDelta">0.00h</div></div>
      </div>
      <div class="chartbox">
        <div class="title" id="dailyChartTitle">Daily Totals (Est vs Tracked) — Week</div>
        <canvas id="barChart" width="1200" height="220"></canvas>
      </div>
      <div class="chartbox">
        <div class="title">Consultants (Est vs Tracked) — Selected Period</div>
        <canvas id="consultantChart" width="1200" height="260"></canvas>
      </div>
      <div style="margin-top:10px">
        <button id="unlockAll" class="">Unlock all estimates (visible period)</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: time entry details -->
<div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modal">
    <header>
      <h3 id="modalTitle">Time Entry</h3>
      <span class="badge" id="modalContext">—</span>
    </header>

    <div class="row">
      <label>Type
        <select id="timeType">
          <option value="">— Select —</option>
          <option>billable | Meeting</option>
          <option>billable | Builds</option>
          <option>billable | Client Correspondence</option>
          <option>PTO</option>
          <option>Holiday</option>
          <option>Non BIllable | Internal Team Meeting</option>
          <option>Non BIllable | Internal Projects</option>
          <option>Non BIllable | L&amp;D</option>
          <option>Non BIllable | PreSales/Sales</option>
          <option>Non BIllable | Client Research</option>
          <option>Non BIllable | Partner Engagement</option>
        </select>
      </label>
    </div>

    <div class="row" id="subTypeRow" style="display:none">
      <label>Sub Type
        <select id="subType">
          <option value="">— Select —</option>
          <option>Firm Initiative</option>
          <option>Internal Delivery project</option>
          <option>Recruitment</option>
          <option>Special Projects</option>
          <option>Events</option>
        </select>
      </label>
    </div>

    <div class="row two">
      <label>Hours
        <input id="modalHours" type="number" min="0" step="0.25" placeholder="e.g., 1.5" />
      </label>
      <div>
        <div class="help">Only Hours will show in the table. All fields are saved for reporting.</div>
      </div>
    </div>

    <footer>
      <button id="modalCancel" class="ghost">Cancel</button>
      <button id="modalSave" class="primary">Save</button>
    </footer>
  </div>
</div>

<script>
// --- START: NEW CLICKUP INTEGRATION SCRIPT ---

/** ========== CORE CONFIGURATION ========== **/
const CLIENT_ID = '6JL5V3OXV2EZ426G9WH3G2SHSD1YZ43B';
const REDIRECT_URI = 'https://l5-time-tracker.vercel.app'; // Your Vercel URL
const VIEW_ID = 'k6hww-66631'; // The View ID for your "Active Projects"

/** ========== GLOBAL STATE ========== **/
let clickup = {
    token: null,
    user: null, // The logged-in user {id, username, role}
    team: null, // The user's primary workspace/team
    allTasks: [], // All tasks from the Active Projects view
    allUsers: [], // All users in the workspace
};

// Your original state variables, which will be controlled by the `clickup` object
let user = null;
let adminViewUser = null;
let weekStart = startOfWeek(new Date());
let data = { rows: [] }; // This will be populated from ClickUp tasks
let viewMode = 'week';
let modalCtx = null;

/** ========== BOOTSTRAP & AUTHENTICATION ========== **/
function init() {
    const urlParams = new URLSearchParams(window.location.search);
    const authCode = urlParams.get('code');
    const storedToken = localStorage.getItem('clickup_access_token');

    if (authCode) {
        document.body.innerHTML = '<h2>Authenticating with ClickUp...</h2>';
        getAccessToken(authCode);
    } else if (storedToken) {
        clickup.token = storedToken;
        loadInitialData();
    } else {
        showLogin();
    }
}

async function getAccessToken(code) {
    try {
        const response = await fetch('/api/get_token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: code }),
        });
        if (!response.ok) throw new Error('Failed to exchange code for token.');
        
        const data = await response.json();
        localStorage.setItem('clickup_access_token', data.accessToken);
        window.history.replaceState({}, '', window.location.pathname);
        init(); // Re-initialize the app
    } catch (error) {
        document.body.innerHTML = `<h2>Authentication Failed</h2><p>${error.message}</p>`;
    }
}

async function loadInitialData() {
    try {
        const response = await fetch('/api/get_data', { headers: { 'Authorization': clickup.token } });
        if (!response.ok) {
            const errorInfo = await response.json();
            throw new Error(errorInfo.error || 'Failed to fetch data');
        }
        const data = await response.json();

        clickup.user = { id: data.userId, username: data.username, role: data.role };
        clickup.team = { id: data.teamId, name: data.teamName };
        clickup.allTasks = data.tasks;

        // Call your original `showApp` function to render the UI
        showApp();

    } catch (error) {
        console.error('Data loading error:', error);
        if (error.message.includes('token') || error.message.includes('unauthorized')) {
            logoutUser();
        } else {
            document.body.innerHTML = `<h1>Error Loading Data</h1><p>${error.message}</p>`;
        }
    }
}

function logoutUser() {
    localStorage.removeItem('clickup_access_token');
    user = null;
    adminViewUser = null;
    window.location.href = REDIRECT_URI;
}


/** ========== Your Original Utilities (Unchanged) ========== **/
const $ = s => document.querySelector(s);
const fmt = n => (isNaN(n)? '0.00' : Number(n).toFixed(2));
const today = new Date();
function startOfWeek(d){ const date = new Date(d); const day = (date.getDay()+6)%7; date.setDate(date.getDate()-day); date.setHours(0,0,0,0); return date; }
function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate()+n); return x; }
function ymd(d){ return d.toISOString().slice(0,10); }
function niceDate(d){ return d.toLocaleDateString(undefined,{month:'short',day:'numeric'}); }
function getActiveIdentity(){ if (user?.role==='admin' && adminViewUser) return adminViewUser; return user; }
function weeksInMonth(year, monthIndex){
  const res = [];
  const firstOfMonth = new Date(year, monthIndex, 1);
  let m = startOfWeek(firstOfMonth);
  while (m.getMonth() <= monthIndex){
    if (m.getMonth() === monthIndex) res.push(new Date(m));
    m = addDays(m,7);
    if (m.getMonth() > monthIndex && m.getDate() > 7) break;
  }
  return res;
}
function labelWeekRange(monday){ const fri = addDays(monday,4); return `${niceDate(monday)} — ${niceDate(fri)}`; }
function buildMonthOptions(current){ const out=[]; const base=new Date(current); base.setDate(1); for(let i=-5;i<=6;i++){ out.push(new Date(base.getFullYear(), base.getMonth()+i, 1)); } return out; }


/** ========== Login / Routing (MODIFIED to use ClickUp data) ========== **/
function showLogin(){ 
    $('#loginView').hidden = false;
    $('#app').hidden = true;
    
    const loginBtn = document.getElementById('loginBtn');
    const loginInputs = document.querySelectorAll('#loginView label, #loginView .tiny');
    
    loginInputs.forEach(el => el.style.display = 'none'); // Hide old inputs
    loginBtn.textContent = 'Login with ClickUp';
    loginBtn.onclick = () => {
        window.location.href = `https://app.clickup.com/api?client_id=${CLIENT_ID}&redirect_uri=${REDIRECT_URI}`;
    };
}

function showApp(){
  $('#loginView').hidden=true;
  $('#app').hidden=false;

  // Set the main user object from the fetched ClickUp data
  const roleName = clickup.user.role <= 2 ? 'admin' : 'consultant';
  user = { username: clickup.user.username, role: roleName, id: clickup.user.id };

  $('#userBadge').textContent = `${user.username} — ${user.role.toUpperCase()}`;
  $('#adminTools').style.display = user.role==='admin' ? 'block' : 'none';
  $('#adminPickerRow').style.display = user.role==='admin' ? 'flex' : 'none';
  
  // Initially render the timesheet for the logged-in user
  const myTasks = clickup.allTasks.filter(t => t.assignees.some(a => a.id === user.id));
  data.rows = myTasks.map(t => ({...t, project: t.name, cells: {}})); // Adapt to your data structure
  render();

  if (user.role==='admin'){
    populateConsultantPicker();
    // Your other admin UI setup calls can go here
    // populateMonthWeekSelectors();
    // setViewButtons();
  }
}

/** ========== Admin Pickers (MODIFIED to use ClickUp data) ========== **/
async function populateConsultantPicker(){
  const picker = $('#consultantPicker');
  picker.innerHTML='<option>Loading users...</option>';

  try {
    const response = await fetch('/api/get_users', {
      method: 'POST',
      headers: { 'Authorization': clickup.token, 'Content-Type': 'application/json' },
      body: JSON.stringify({ teamId: clickup.team.id })
    });
    if (!response.ok) throw new Error('Could not fetch users');
    
    const users = await response.json();
    clickup.allUsers = users;
    
    picker.innerHTML='';
    users.forEach(u => {
      const opt = document.createElement('option');
      opt.value = u.user.id;
      opt.textContent = u.user.username;
      picker.appendChild(opt);
    });

    picker.value = user.id; // Default to the logged-in admin

    picker.onchange = () => {
        const selectedUserId = parseInt(picker.value, 10);
        const selectedUser = clickup.allUsers.find(u => u.user.id === selectedUserId);
        
        // Set your original adminViewUser variable
        adminViewUser = { username: selectedUser.user.username, id: selectedUser.user.id, role: 'consultant' };
        $('#viewingBadge').style.display = adminViewUser.id !== user.id ? 'inline-flex' : 'none';
        $('#viewingBadge').textContent = `Viewing: ${adminViewUser.username}`;

        // Filter tasks for the selected user and re-render
        const filteredTasks = clickup.allTasks.filter(t => t.assignees.some(a => a.id === selectedUserId));
        data.rows = filteredTasks.map(t => ({...t, project: t.name, cells: {}}));
        render();
    };

  } catch (error) {
    console.error(error);
    picker.innerHTML = '<option>Error loading users</option>';
  }
}

/** ========== Table Rendering (MODIFIED to use ClickUp data) ========== **/
function render(){
  // This is YOUR original render function, slightly adapted to use the new data structure.
  buildHead();
  const tbody=$('#tbody');
  tbody.innerHTML='';
  
  if (data.rows.length === 0) {
      const activeUser = getActiveIdentity();
      tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding: 20px;">No projects found for ${activeUser.username}.</td></tr>`;
      return;
  }
  
  data.rows.forEach(row=>{ // `row` is now a task object from ClickUp
    const tr=document.createElement('tr');
    tr.dataset.taskId = row.id;
    
    const tdProj=document.createElement('td');
    tdProj.className='proj-cell';
    tdProj.textContent = row.project; // Using the 'project' property we added
    tr.appendChild(tdProj);

    let rowEstTotal=0, rowTrkTotal=0;
    for(let d=0; d<5; d++){
      const td=document.createElement('td'); 
      const c = row.cells[d] || {est:'',tracked:'',estLocked:false, trackedMeta:null};
      row.cells[d]=c;
      const box=document.createElement('div');
      box.className='cellBox';

      const est=document.createElement('input'); 
      est.type='number'; est.step='0.25'; est.min='0'; est.placeholder='Est'; est.className='num est-input';
      
      const tracked=document.createElement('input'); 
      tracked.type='number'; tracked.step='0.25'; tracked.min='0'; tracked.placeholder='Tracked'; tracked.className='num tracked-input';
      tracked.readOnly=true;
      tracked.addEventListener('click', ()=> openTimeModal({wkMon:new Date(weekStart), row: row, dayIdx:d, c}));
      
      box.append(est, tracked);
      td.appendChild(box);
      tr.appendChild(td);
    }
    const tdTotal=document.createElement('td');
    const tot=document.createElement('div');
    tot.className='cellBox';
    const estTot=document.createElement('input'); estTot.className='num'; estTot.disabled=true; estTot.value=fmt(rowEstTotal);
    const trkTot=document.createElement('input'); trkTot.className='num'; trkTot.disabled=true; trkTot.value=fmt(rowTrkTotal);
    tot.append(estTot, trkTot);
      tdTotal.appendChild(tot);
    tr.appendChild(tdTotal);
    tbody.appendChild(tr);
  });
  updateAllSummaries();
}

/** ========== Save Logic (MODIFIED to save to ClickUp) ========== **/
async function save(){
    const saveButton = $('#saveAll');
    saveButton.textContent = 'Saving...';
    saveButton.disabled = true;

    const timeEntries = [];
    const rows = document.querySelectorAll('#tbody tr[data-task-id]');

    rows.forEach((row, rowIndex) => {
        const taskId = row.dataset.taskId;
        const trackedInputs = row.querySelectorAll('.tracked-input');
        
        trackedInputs.forEach((input, dayIndex) => {
            const hours = parseFloat(input.value);
            if (hours > 0) {
                timeEntries.push({
                    taskId: taskId,
                    date: addDays(weekStart, dayIndex),
                    hours: hours,
                });
            }
        });
    });

    if (timeEntries.length === 0) {
        alert('No time to save.');
        saveButton.textContent = 'Save';
        saveButton.disabled = false;
        return;
    }

    try {
        const response = await fetch('/api/save_time', {
            method: 'POST',
            headers: { 'Authorization': clickup.token, 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                timeEntries: timeEntries, 
                teamId: clickup.team.id,
                userId: getActiveIdentity().id
            })
        });
        if (!response.ok) throw new Error('Failed to save to ClickUp');

        alert('Time saved successfully!');
    } catch (error) {
        console.error(error);
        alert('Error saving time to ClickUp.');
    } finally {
        saveButton.textContent = 'Save';
        saveButton.disabled = false;
    }
}


/** ========== Your Original Untouched Functions Below ========== **/
// (These functions should work as-is with the new data structure)

function buildHead(){
  const thead = $('#thead'); thead.innerHTML='';
  const tr1 = document.createElement('tr');
  const baseTh = document.createElement('th'); baseTh.textContent='Project'; baseTh.className='proj-cell';
  tr1.appendChild(baseTh);
  const weekDaysArr=[]; 
  for(let i=0;i<5;i++){ const d=addDays(weekStart,i); weekDaysArr.push(d);
    const th=document.createElement('th'); th.innerHTML = `<div>${['Mon','Tue','Wed','Thu','Fri'][i]} • ${niceDate(d)}</div><div class="tiny">Est | Tracked</div>`; tr1.appendChild(th); }
  const thT=document.createElement('th'); thT.innerHTML='<div>Total (Week)</div><div class="tiny">Est | Tracked</div>'; tr1.appendChild(thT);
  $('#weekLabel').textContent = `${niceDate(weekDaysArr[0])} — ${niceDate(weekDaysArr[4])}`;
  thead.appendChild(tr1);
}

function updateAllSummaries(){
    const rows = document.querySelectorAll('#tbody tr[data-task-id]');
    let grandTotalEst = 0;
    let grandTotalTrk = 0;

    rows.forEach(row => {
        let rowTotalEst = 0;
        let rowTotalTrk = 0;
        row.querySelectorAll('.est-input').forEach(input => rowTotalEst += (parseFloat(input.value) || 0));
        row.querySelectorAll('.tracked-input').forEach(input => rowTotalTrk += (parseFloat(input.value) || 0));
        
        const totalCells = row.querySelectorAll('td:last-child input');
        totalCells[0].value = fmt(rowTotalEst);
        totalCells[1].value = fmt(rowTotalTrk);

        grandTotalEst += rowTotalEst;
        grandTotalTrk += rowTotalTrk;
    });

    $('#sumEst').textContent=`Est: ${fmt(grandTotalEst)}h`;
    $('#sumTracked').textContent=`Tracked: ${fmt(grandTotalTrk)}h`;
    $('#sumDelta').textContent=`Δ (Tracked–Est): ${fmt(grandTotalTrk - grandTotalEst)}h`;
}

function openTimeModal(ctx){
  modalCtx = ctx;
  const proj = ctx.row.project || '(Untitled Project)';
  const theDay = ['Mon','Tue','Wed','Thu','Fri'][ctx.dayIdx];
  $('#modalContext').textContent = `${proj} • ${theDay} • ${niceDate(addDays(ctx.wkMon, ctx.dayIdx))}`;
  const meta = ctx.c.trackedMeta || {};
  $('#timeType').value = meta.type || '';
  $('#subType').value  = meta.subType || '';
  $('#modalHours').value = ctx.c.tracked ?? '';
  toggleSubType();
  $('#modalBackdrop').style.display='flex';
  setTimeout(()=>$('#modalHours').focus(), 10);
}

function closeTimeModal(){ $('#modalBackdrop').style.display='none'; modalCtx=null; }

function toggleSubType(){
  const v = ($('#timeType').value||'').trim();
  const show = v.toLowerCase().includes('internal projects');
  $('#subTypeRow').style.display = show ? 'block' : 'none';
  if (!show) $('#subType').value = '';
}

// Event Listeners for your UI
$('#logout').addEventListener('click', logoutUser);
$('#saveAll').addEventListener('click', save);
// We can reconnect the rest of the buttons (prev/next week, etc.) next.
// The modal save needs to be updated to not use localStorage.
$('#modalSave').addEventListener('click', () => {
    if (!modalCtx) return;
    const hours = $('#modalHours').value;
    // Find the right input on the grid and update its value
    const row = document.querySelector(`tr[data-task-id="${modalCtx.row.id}"]`);
    if(row) {
        const input = row.querySelectorAll('.tracked-input')[modalCtx.dayIdx];
        input.value = hours;
        updateAllSummaries();
    }
    closeTimeModal();
});
$('#modalCancel').addEventListener('click', closeTimeModal);
$('#timeType').addEventListener('change', toggleSubType);

/** Boot */
init();
</script>
</body>
</html>
