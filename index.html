<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Time Tracking — v8</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f1115; --panel:#171a21; --muted:#8b94a7; --text:#e8ecf1;
      --accent:#4f8cff; --accent-2:#22c55e; --warn:#f59e0b; --danger:#ef4444;
      --border:#242a35; --input:#11141a; --good:#22c55e; --bad:#ef4444;
      --radius:12px;
    }
    *{box-sizing:border-box}
    body{ margin:0; font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
      color:var(--text); background:linear-gradient(180deg,#0f1115,#0b0d12 60%);
      min-height:100vh; display:flex; align-items:center; justify-content:center; padding:24px; }
    .card{ width:min(1300px,100%); background:var(--panel); border:1px solid var(--border);
      border-radius:var(--radius); box-shadow:0 10px 30px rgba(0,0,0,.35); overflow:hidden; }
    header{ padding:18px 22px; display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid var(--border); background:rgba(255,255,255,.02); }
    .brand{display:flex; gap:10px; align-items:center}
    .logo{ width:34px; height:34px; display:grid; place-items:center; border-radius:10px;
      background:linear-gradient(135deg,var(--accent),#7aa8ff); color:white; font-weight:800; }
    .muted{color:var(--muted)}
    .role-badge{ font-size:12px; padding:6px 10px; border:1px solid var(--border);
      border-radius:999px; color:var(--muted); background:rgba(255,255,255,.02); }
    .wrap{padding:22px}
    .controls{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    button, a.button { appearance:none; border:1px solid var(--border); background:#11141a; color:var(--text); text-decoration: none;
      padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; text-align: center; }
    button.primary, a.button.primary{background:var(--accent); border-color:transparent; color:white; font-weight:600}
    button.success{background:var(--accent-2); border-color:transparent; color:#06240f; font-weight:600}
    button.warn{background:var(--warn); border-color:transparent; color:#1b1404; font-weight:600}
    button.ghost{background:transparent}
    button:disabled{opacity:.6; cursor:not-allowed}
    input, select{ width:100%; background:var(--input); border:1px solid var(--border); color:var(--text);
      border-radius:10px; padding:10px 12px; outline:none; }
    input[disabled].locked{ background:rgba(79,140,255,.08); border-color:rgba(79,140,255,.35); color:#bcd2ff; }
    .grid{ overflow:auto; border:1px solid var(--border); border-radius:12px; margin-top:14px; }
    table{border-collapse:separate; border-spacing:0; width:100%;}
    thead th{ position:sticky; top:0; z-index:2; background:#12151c; color:#c8d2e3;
      border-bottom:1px solid var(--border); text-align:left; font-weight:600; padding:12px; white-space:nowrap; }
    th, td{border-bottom:1px solid var(--border); padding:10px; vertical-align:middle; white-space:nowrap}
    tbody tr:nth-child(even){background:rgba(255,255,255,.02)}
    tfoot td{background:#10131a; color:#d7dfef; font-weight:600}
    .proj-cell{min-width:220px; position:sticky; left:0; background:inherit; z-index:3}
    .num{text-align:right}
    .tiny{font-size:12px; color:var(--muted)}
    .pill{ font-size:12px; padding:4px 8px; border:1px solid var(--border); border-radius:999px; color:#cbd5e1; background:#0f131a; }
    .linklike{color:#7aa8ff; cursor:pointer; text-decoration:underline}
    .dash{display:grid; grid-template-columns:repeat(3, minmax(0,1fr)); gap:12px; margin-top:16px;}
    .kpi{background:#0f131a; border:1px solid var(--border); border-radius:12px; padding:14px;}
    .kpi .label{font-size:12px; color:var(--muted); margin-bottom:6px}
    .kpi .value{font-size:22px; font-weight:700}
    .kpi.delta.positive .value{color:var(--good)}
    .kpi.delta.negative .value{color:var(--bad)}
    .chartbox{margin-top:12px; background:#0f131a; border:1px solid var(--border); border-radius:12px; padding:12px; overflow:auto;}
    canvas{width:100%; height:220px}
    .pickerRow{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:8px}
    .label{font-size:12px; color:var(--muted)}
    .togglegrp{display:flex; gap:6px; align-items:center}
    .cellBox{display:grid; grid-template-columns:1fr 1fr; gap:6px}
    .login-container { max-width: 320px; margin: 0 auto; padding: 20px;}
    /* MODAL */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:10; }
    .modal{ width:min(520px, 92vw); background:#0f131a; border:1px solid var(--border); border-radius:14px; padding:18px; box-shadow:0 20px 60px rgba(0,0,0,.6); }
    .modal header{ display:flex; align-items:center; justify-content:space-between; padding:0 0 10px 0; border:0; }
    .modal h3{ margin:0; font-size:18px }
    .modal .row{ display:grid; gap:8px; margin:12px 0 }
    .modal .row.two{ grid-template-columns:1fr 1fr; }
    .modal footer{ display:flex; gap:10px; justify-content:flex-end; margin-top:8px }
    .help{ font-size:12px; color:var(--muted) }
    .badge{ display:inline-flex; font-size:11px; padding:2px 8px; border:1px solid var(--border); border-radius:999px; color:#cbd5e1 }
  </style>
</head>
<body>

<div id="loginView" class="login-container">
  <div class="brand" style="margin-bottom:14px; justify-content: center;">
    <div class="logo">TT</div>
    <div>
      <div style="font-weight:700">Weekly Time Tracking</div>
      <div class="muted">L5 Time Tracker</div>
    </div>
  </div>
  <h2 style="margin-top: 30px;">Sign in</h2>
  <p class="tiny">You will be redirected to ClickUp to authorize this application.</p>
  <div id="authContainer" style="margin-top: 20px;">
    <a href="#" id="loginButton" class="button primary" style="width: 100%;">Login with ClickUp</a>
  </div>
</div>

<div id="app" class="card" hidden>
  <header>
    <div class="brand">
      <div class="logo">TT</div>
      <div>
        <div style="font-weight:800">Time Tracking</div>
        <div class="muted" id="weekLabel"></div>
      </div>
    </div>
    <div class="controls">
      <span id="userBadge" class="role-badge"></span>
      <span id="viewingBadge" class="role-badge" style="display:none"></span>
      <button id="prevWeek" class="ghost">◀ Prev</button>
      <button id="thisWeek" class="ghost" title="Jump to current week">This Week</button>
      <button id="nextWeek" class="ghost">Next ▶</button>
      <button id="addRow" class="">+ Add Project</button>
      <button id="saveAll" class="success">Save</button>
      <button id="exportCsv" class="">Export CSV</button>
      <button id="logout" class="warn">Log out</button>
    </div>
  </header>
  <div class="wrap">
    <div id="adminPickerRow" class="pickerRow" style="display:none">
      </div>
    <div class="sumbar">
      <span class="pill" id="sumEst">Est: 0.00h</span>
      <span class="pill" id="sumTracked">Tracked: 0.00h</span>
      <span class="pill" id="sumDelta">Δ (Tracked–Est): 0.00h</span>
    </div>
    <div class="grid">
      <table id="timesheet">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
        <tfoot id="tfoot"></tfoot>
      </table>
    </div>
    <div id="adminTools" style="margin-top:12px; display:none">
      </div>
  </div>
</div>

<div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    </div>

<script>
// --- START: CLICKUP INTEGRATION ---

const CLIENT_ID = '6JL5V3OXV2EZ426G9WH3G2SHSD1YZ43B';
const REDIRECT_URI = 'https://l5-time-tracker.vercel.app'; // Your Vercel URL

const loginView = document.getElementById('loginView');
const appView = document.getElementById('app');
const loginButton = document.getElementById('loginButton');
const authContainer = document.getElementById('authContainer');
const userBadge = document.getElementById('userBadge');

function initAuth() {
    const urlParams = new URLSearchParams(window.location.search);
    const authCode = urlParams.get('code');
    const accessToken = localStorage.getItem('clickup_access_token');

    if (accessToken) {
        fetchClickUpData(accessToken);
    } else if (authCode) {
        getAccessToken(authCode);
    } else {
        showLogin();
    }
}

loginButton.onclick = function() {
    const authUrl = `https://app.clickup.com/api?client_id=${CLIENT_ID}&redirect_uri=${REDIRECT_URI}`;
    window.location.href = authUrl;
};

document.getElementById('logout').onclick = function() {
    localStorage.removeItem('clickup_access_token');
    user = null; // Clear the user from your original script's state
    showLogin();
};

async function getAccessToken(code) {
    authContainer.innerHTML = '<h4>Authenticating...</h4>';
    try {
        const response = await fetch('/api/get_token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: code }),
        });
        if (!response.ok) throw new Error('Failed to exchange code for token.');
        
        const data = await response.json();
        localStorage.setItem('clickup_access_token', data.accessToken);
        window.history.replaceState({}, document.title, window.location.pathname);
        initAuth();
    } catch (error) {
        authContainer.innerHTML = `<p style="color:var(--danger);">Authentication failed. Please try again.</p>`;
    }
}

async function fetchClickUpData(token) {
    try {
        const response = await fetch('/api/get_data', { headers: { 'Authorization': token } });
        if (!response.ok) {
            const errorInfo = await response.json();
            throw new Error(errorInfo.error || 'Failed to fetch data');
        }
        const data = await response.json();
        
        // ClickUp roles: 1=owner, 2=admin, 3=member, 4=guest
        // Your clarification: consultant=member
        let roleName = 'consultant'; // Default role
        if (data.role <= 2) {
            roleName = 'admin';
        }

        const clickupUser = {
            id: data.userId,
            username: data.username,
            role: roleName,
            teamId: data.teamId,
            allTasks: data.tasks // Store all tasks if admin
        };
        
        showApp(clickupUser); // Show the main application UI
        render(data.tasks); // Render the timesheet with tasks from ClickUp

    } catch (error) {
        // If token is invalid, clear it and force re-login
        if (error.message.includes('token')) {
            localStorage.removeItem('clickup_access_token');
            initAuth();
        } else {
            document.body.innerHTML = `<h1>Error</h1><p>${error.message}</p>`;
        }
    }
}

// --- END: CLICKUP INTEGRATION ---

/** ========== Utilities & State (Your Original Code) ========== **/
const $ = s => document.querySelector(s);
const fmt = n => (isNaN(n)? '0.00' : Number(n).toFixed(2));
const today = new Date();
function startOfWeek(d){ const date = new Date(d); const day = (date.getDay()+6)%7; date.setDate(date.getDate()-day); date.setHours(0,0,0,0); return date; }
function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate()+n); return x; }
function niceDate(d){ return d.toLocaleDateString(undefined,{month:'short',day:'numeric'}); }

let user = null;
let weekStart = startOfWeek(today);

/** ========== Login / Routing (Modified for ClickUp) ========== **/
function showLogin(){ 
    loginView.hidden=false; 
    appView.hidden=true; 
}

function showApp(clickupUser){
  user = clickupUser; // Set the global user object

  loginView.hidden=true;
  appView.hidden=false;
  
  userBadge.textContent = `${user.username} — ${user.role.toUpperCase()}`;
  
  // Logic for admin view will be added in a later step
  $('#adminTools').style.display = 'none';
  $('#adminPickerRow').style.display = 'none';

  buildHead();
}

/** ========== Table Rendering (MODIFIED to use ClickUp data) ========== **/
function buildHead(){
  const thead = $('#thead');
  thead.innerHTML='';
  const tr1 = document.createElement('tr');
  const baseTh = document.createElement('th');
  baseTh.textContent='Project';
  baseTh.className='proj-cell';
  tr1.appendChild(baseTh);

  const weekDays = [];
  for(let i=0;i<5;i++){
      const d=addDays(weekStart,i);
      weekDays.push(d);
      const th=document.createElement('th');
      th.innerHTML = `<div>${['Mon','Tue','Wed','Thu','Fri'][i]} • ${niceDate(d)}</div><div class="tiny">Est | Tracked</div>`;
      tr1.appendChild(th);
  }
  const thT=document.createElement('th');
  thT.innerHTML='<div>Total (Week)</div><div class="tiny">Est | Tracked</div>';
  tr1.appendChild(thT);
  $('#weekLabel').textContent = `${niceDate(weekDays[0])} — ${niceDate(weekDays[4])}`;
  thead.appendChild(tr1);
}

// THIS IS THE NEW RENDER FUNCTION
function render(tasks) {
  const tbody=$('#tbody');
  tbody.innerHTML='';
  
  if (!tasks || tasks.length === 0) {
      tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 20px;">No projects assigned to you in the "Active Projects" view.</td></tr>`;
      return;
  }

  tasks.forEach(task => {
    const tr = document.createElement('tr');
    tr.dataset.taskId = task.id; // Store ClickUp task ID

    // Create the project cell (not editable)
    const tdProj = document.createElement('td');
    tdProj.className = 'proj-cell';
    tdProj.textContent = task.name;
    tr.appendChild(tdProj);

    // Create the 5 daily input cells
    for(let d = 0; d < 5; d++){
      const td = document.createElement('td');
      const box = document.createElement('div');
      box.className = 'cellBox';

      const est = document.createElement('input');
      est.type = 'number';
      est.step = '0.25';
      est.min = '0';
      est.placeholder = 'Est';
      est.className = 'num est-input';
      
      const tracked = document.createElement('input');
      tracked.type = 'number';
      tracked.step = '0.25';
      tracked.min = '0';
      tracked.placeholder = 'Tracked';
      tracked.className = 'num tracked-input';

      box.append(est, tracked);
      td.appendChild(box);
      tr.appendChild(td);
    }
    
    // Create the total cell
    const tdTotal = document.createElement('td');
    const tot = document.createElement('div');
    tot.className = 'cellBox';
    const estTot = document.createElement('input');
    estTot.className = 'num';
    estTot.disabled = true;
    estTot.value = '0.00';
    const trkTot = document.createElement('input');
    trkTot.className = 'num';
    trkTot.disabled = true;
    trkTot.value = '0.00';
    tot.append(estTot, trkTot);
    tdTotal.appendChild(tot);
    tr.appendChild(tdTotal);
    
    tbody.appendChild(tr);
  });
  
  // We'll add footer and summary updates in the next step
  updateAllSummaries();
}

function updateAllSummaries() {
    // This function will be expanded in the next step to calculate totals
    console.log("Updating summaries...");
}


// All other functions from your original file will be re-integrated
// in the next steps as we add back their functionality (modals, saving, etc.)

/** Boot */
initAuth(); // Start the new ClickUp auth flow

</script>
</body>
</html>