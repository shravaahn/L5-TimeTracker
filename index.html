<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Time Tracking â€” v8</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f1115; --panel:#171a21; --muted:#8b94a7; --text:#e8ecf1;
      --accent:#7b68ee; --accent-2:#22c55e; --warn:#f59e0b; --danger:#ef4444;
      --border:#242a35; --input:#11141a; --good:#22c55e; --bad:#ef4444;
      --radius:12px;
    }
    *{box-sizing:border-box}
    body{ margin:0; font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
      color:var(--text); background:linear-gradient(180deg,#0f1115,#0b0d12 60%);
      min-height:100vh; display:flex; align-items:center; justify-content:center; padding:24px; }
    .card{ width:min(1300px,100%); background:var(--panel); border:1px solid var(--border);
      border-radius:var(--radius); box-shadow:0 10px 30px rgba(0,0,0,.35); overflow:hidden; }
    header{ padding:18px 22px; display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid var(--border); background:rgba(255,255,255,.02); }
    .brand{display:flex; gap:10px; align-items:center}
    .logo{ width:34px; height:34px; display:grid; place-items:center; border-radius:10px;
      background:var(--accent); color:white; font-weight:800; }
    .muted{color:var(--muted)}
    .role-badge{ font-size:12px; padding:6px 10px; border:1px solid var(--border);
      border-radius:999px; color:var(--muted); background:rgba(255,255,255,.02); }
    .wrap{padding:22px}
    .controls{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    button, a.button{ text-decoration: none; display: inline-block; appearance:none; border:1px solid var(--border); background:#11141a; color:var(--text);
      padding:10px 14px; border-radius:10px; cursor:pointer; font-weight: 600; text-align: center;}
    button.primary, a.button.primary{background:var(--accent); border-color:transparent; color:white; font-weight:600}
    button.success{background:var(--accent-2); border-color:transparent; color:#06240f; font-weight:600}
    button.warn{background:var(--warn); border-color:transparent; color:#1b1404; font-weight:600}
    button.ghost{background:transparent}
    button:disabled{opacity:.6; cursor:not-allowed}
    input, select{ width:100%; background:var(--input); border:1px solid var(--border); color:var(--text);
      border-radius:10px; padding:10px 12px; outline:none; }
    input[disabled].locked{ background:rgba(79,140,255,.08); border-color:rgba(79,140,255,.35); color:#bcd2ff; }
    .grid{ overflow:auto; border:1px solid var(--border); border-radius:12px; margin-top:14px; }
    table{border-collapse:separate; border-spacing:0; width:100%;}
    thead th{ position:sticky; top:0; z-index:2; background:#12151c; color:#c8d2e3;
      border-bottom:1px solid var(--border); text-align:left; font-weight:600; padding:12px; white-space:nowrap; }
    th, td{border-bottom:1px solid var(--border); padding:10px; vertical-align:middle; white-space:nowrap}
    tbody tr:nth-child(even){background:rgba(255,255,255,.02)}
    tfoot td{background:#10131a; color:#d7dfef; font-weight:600}
    .proj-cell{min-width:220px; position:sticky; left:0; background:inherit; z-index:3}
    .num{text-align:right}
    .tiny{font-size:12px; color:var(--muted)}
    .pickerRow{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:8px}
    .cellBox{display:grid; grid-template-columns:1fr 1fr; gap:6px}
    .login-container { text-align: center; max-width: 320px; margin: 0 auto; }
  </style>
</head>
<body>

<div id="loginView" class="login-container">
  <div class="brand" style="margin-bottom:14px; justify-content: center;">
    <div class="logo">TT</div>
    <div>
      <div style="font-weight:700">Weekly Time Tracking</div>
      <div class="muted">L5 Time Tracker</div>
    </div>
  </div>
  <h2 style="margin-top: 30px;">Sign in</h2>
  <p class="tiny">You will be redirected to ClickUp to authorize this application.</p>
  <a href="#" id="loginButton" class="button primary" style="width: 100%; margin-top: 20px;">Login with ClickUp</a>
</div>

<div id="app" class="card hidden">
  <header>
    <div class="brand">
      <div class="logo">TT</div>
      <div>
        <div style="font-weight:800">Time Tracking</div>
        <div class="muted" id="weekLabel"></div>
      </div>
    </div>
    <div class="controls">
      <span id="userBadge" class="role-badge"></span>
      <button id="logout" class="warn">Log out</button>
    </div>
  </header>
  <div class="wrap">
     <p>Login successful! The timesheet will be rendered here.</p>
  </div>
</div>

<script>
// --- CLICKUP API CONFIGURATION ---
const CLIENT_ID = '6JL5V3OXV2EZ426G9WH3G2SHSD1YZ43B';
const REDIRECT_URI = 'https://l5-time-tracker.vercel.app'; // Your Vercel URL

// --- DOM ELEMENTS ---
const loginView = document.getElementById('loginView');
const appView = document.getElementById('app');
const loginButton = document.getElementById('loginButton');
const logoutButton = document.getElementById('logout');
const userBadge = document.getElementById('userBadge');

// --- AUTHENTICATION FLOW ---
window.onload = function() {
    const urlParams = new URLSearchParams(window.location.search);
    const authCode = urlParams.get('code');
    const accessToken = localStorage.getItem('clickup_access_token');

    if (accessToken) {
        showApp();
        fetchData(accessToken);
    } else if (authCode) {
        getAccessToken(authCode);
    } else {
        showLogin();
    }
};

loginButton.onclick = function() {
    const authUrl = `https://app.clickup.com/api?client_id=${CLIENT_ID}&redirect_uri=${REDIRECT_URI}`;
    window.location.href = authUrl;
};

logoutButton.onclick = function() {
    localStorage.removeItem('clickup_access_token');
    showLogin();
};

async function getAccessToken(code) {
    // Show a loading state
    loginView.innerHTML = '<h2>Authenticating...</h2>';
    try {
        const response = await fetch('/api/get_token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: code }),
        });
        if (!response.ok) throw new Error('Failed to get access token');
        
        const data = await response.json();
        localStorage.setItem('clickup_access_token', data.accessToken);
        window.history.replaceState({}, document.title, window.location.pathname); // Clean URL
        window.onload(); // Re-run the onload function to now use the token
    } catch (error) {
        loginView.innerHTML = `<h2>Authentication Failed</h2><p>${error.message}</p>`;
    }
}

async function fetchData(token) {
    console.log("Logged in! Next step: Fetch data and render the timesheet.");
    // In the next step, we will use this function to get user info and tasks
    // and then call the original rendering functions from timeV8.html.
    
    // For now, just show a welcome message.
    userBadge.textContent = "Loading...";
}

// --- UI HELPERS ---
function showLogin() {
    loginView.classList.remove('hidden');
    appView.classList.add('hidden');
}

function showApp() {
    loginView.classList.add('hidden');
    appView.classList.remove('hidden');
}

// We will add all your other JavaScript functions from timeV8.html here
// in the upcoming steps (e.g., renderTimesheet, buildHead, updateTotals, etc.)

</script>
</body>
</html>