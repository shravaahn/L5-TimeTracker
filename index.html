<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>L5 Time Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f1115; --panel:#171a21; --muted:#8b94a7; --text:#e8ecf1;
      --accent:#7b68ee; --accent-2:#22c55e; --warn:#f59e0b; --danger:#ef4444;
      --border:#242a35; --input:#11141a;
      --radius:12px;
    }
    *{box-sizing:border-box}
    body{ margin:0; font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; color:var(--text); background:var(--bg); min-height:100vh; }
    .center-view{ display:grid; place-content:center; min-height:100vh; padding:24px; }
    .hidden{display:none}
    .card{ width:min(1300px,100%); background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); box-shadow:0 10px 30px rgba(0,0,0,.35); overflow:hidden; }
    header{ padding:18px 22px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--border); background:rgba(255,255,255,.02); }
    .brand{display:flex; gap:10px; align-items:center}
    .logo{ width:34px; height:34px; display:grid; place-items:center; border-radius:10px; background:var(--accent); color:white; font-weight:800; }
    .wrap{padding:22px}
    .controls{display:flex; align-items:center; gap:10px;}
    button, select, a.button { appearance:none; border:1px solid var(--border); background:#11141a; color:var(--text); text-decoration: none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; text-align: center; }
    button.primary, a.button.primary{background:var(--accent); border-color:transparent; color:white; font-weight:600}
    button.success{background:var(--accent-2); border-color:transparent; color:#062f13;}
    button.warn{background:var(--warn); border-color:transparent; color:#1b1404;}
    button:disabled{opacity:.6; cursor:not-allowed}
    .grid{ overflow:auto; border:1px solid var(--border); border-radius:12px; margin-top:14px; }
    table{border-collapse:separate; border-spacing:0; width:100%;}
    thead th{ position:sticky; top:0; z-index:2; background:#12151c; color:#c8d2e3; border-bottom:1px solid var(--border); text-align:left; font-weight:600; padding:12px; white-space:nowrap; }
    th, td{border-bottom:1px solid var(--border); padding:10px; vertical-align:middle; white-space:nowrap}
    .proj-cell{min-width:300px; position:sticky; left:0; background:inherit; z-index:1}
    .num{text-align:right}
    .tiny{font-size:12px; color:var(--muted)}
    .pickerRow{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:12px}
    .pickerRow .label{font-size:12px; color:var(--muted)}
  </style>
</head>
<body>

<div id="container" class="center-view">
    </div>

<script>
    // --- TEMPLATES ---
    const loginTemplate = `
        <div class="center-view">
            <a href="#" id="loginButton" class="button primary">Login with ClickUp</a>
        </div>
    `;

    const appTemplate = `
        <div class="card">
            <header>
                <div class="brand">
                    <div class="logo">L5</div>
                    <div>
                        <div style="font-weight:800">Time Tracking</div>
                        <div class="muted" id="weekLabel"></div>
                    </div>
                </div>
                <div class="controls">
                    <span id="welcomeMessage" class="tiny"></span>
                    <button id="logoutButton" class="warn">Log Out</button>
                    <button id="saveAll" class="success">Save</button>
                </div>
            </header>
            <div class="wrap">
                <div id="adminPickerRow" class="pickerRow hidden">
                    <span class="label">VIEWING AS ADMIN:</span>
                    <select id="consultantPicker" style="min-width:220px"></select>
                </div>
                <div class="grid">
                    <table id="timesheet">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    `;

    // --- CONFIGURATION ---
    const CLIENT_ID = 'PASTE_YOUR_CLIENT_ID_HERE';
    const REDIRECT_URI = 'https://l5-time-tracker.vercel.app'; // Your Vercel URL
    const CONTAINER = document.getElementById('container');

    // --- GLOBAL STATE ---
    let appData = {
        accessToken: null,
        teamId: null,
        loggedInUser: null,
        allTasksFromView: [],
    };

    // --- MAIN APP LOGIC ---
    async function init() {
        const urlParams = new URLSearchParams(window.location.search);
        const authCode = urlParams.get('code');
        const storedToken = localStorage.getItem('clickup_access_token');

        if (authCode) {
            CONTAINER.innerHTML = `<h2>Authenticating...</h2>`;
            try {
                const token = await getAccessToken(authCode);
                localStorage.setItem('clickup_access_token', token);
                window.history.replaceState({}, document.title, window.location.pathname);
                await loadApp(token);
            } catch (error) {
                CONTAINER.innerHTML = `<h2>Authentication Failed</h2><p>${error.message}</p>`;
            }
        } else if (storedToken) {
            await loadApp(storedToken);
        } else {
            showLogin();
        }
    }

    function showLogin() {
        CONTAINER.innerHTML = loginTemplate;
        document.getElementById('loginButton').onclick = () => {
            const authUrl = `https://app.clickup.com/api?client_id=${CLIENT_ID}&redirect_uri=${REDIRECT_URI}`;
            window.location.href = authUrl;
        };
    }

    async function loadApp(token) {
        CONTAINER.className = ''; // Reset class for app view
        CONTAINER.innerHTML = appTemplate;
        appData.accessToken = token;

        // Add event listeners for the newly created app elements
        document.getElementById('logoutButton').onclick = logout;
        document.getElementById('saveAll').onclick = saveData;

        try {
            const data = await fetchData();
            appData.loggedInUser = { id: data.userId, username: data.username, role: data.role };
            appData.teamId = data.teamId;
            appData.allTasksFromView = data.tasks;

            document.getElementById('welcomeMessage').textContent = `Welcome, ${appData.loggedInUser.username}!`;

            if (appData.loggedInUser.role <= 2) { // Is Admin or Owner
                document.getElementById('adminPickerRow').classList.remove('hidden');
                await populateConsultantPicker();
                // When dropdown changes, re-render the timesheet with filtered tasks
                document.getElementById('consultantPicker').addEventListener('change', (e) => {
                    renderTimesheetForUser(e.target.value);
                });
            }
            
            // Initial render for the logged-in user
            renderTimesheetForUser(appData.loggedInUser.id);

        } catch (error) {
            // Handle token-related fetch errors
            if (error.message.includes('token')) {
                logout();
            } else {
                CONTAINER.innerHTML = `<h1>Error</h1><p>${error.message}</p>`;
            }
        }
    }
    
    function renderTimesheetForUser(userId) {
        const tasksToRender = appData.allTasksFromView.filter(task => 
            task.assignees.some(assignee => assignee.id == userId)
        );
        renderTimesheet(tasksToRender);
    }

    function logout() {
        localStorage.removeItem('clickup_access_token');
        CONTAINER.className = 'center-view';
        showLogin();
    }
    
    // --- API HELPER FUNCTIONS ---
    async function getAccessToken(code) {
        const response = await fetch('/api/get_token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: code }),
        });
        if (!response.ok) throw new Error('Failed to exchange code for token.');
        const data = await response.json();
        return data.accessToken;
    }

    async function fetchData() {
        const response = await fetch('/api/get_data', { headers: { 'Authorization': appData.accessToken } });
        if (!response.ok) {
            const errorInfo = await response.json();
            throw new Error(errorInfo.error || 'Failed to fetch data');
        }
        return await response.json();
    }

    async function populateConsultantPicker() {
        const consultantPicker = document.getElementById('consultantPicker');
        const response = await fetch('/api/get_users', {
            method: 'POST',
            headers: {
                'Authorization': appData.accessToken,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ teamId: appData.teamId })
        });
        if (!response.ok) return; // Fail silently
        const members = await response.json();
        
        consultantPicker.innerHTML = '';
        members.forEach(member => {
            const opt = document.createElement('option');
            opt.value = member.user.id;
            opt.textContent = member.user.username;
            consultantPicker.appendChild(opt);
        });
        // Set the default selection to the currently logged-in user
        consultantPicker.value = appData.loggedInUser.id;
    }

    async function saveData() {
        // This is where the save logic will go.
        alert('Save functionality is the next step!');
    }

    // --- UI RENDERING ---
    function renderTimesheet(tasks) {
        const timesheetHead = document.querySelector('#timesheet thead');
        const timesheetBody = document.querySelector('#timesheet tbody');
        
        // Build Header
        const weekDays = getWeekDays();
        let headHTML = `<tr><th class="proj-cell">Project</th>`;
        ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'].forEach((day, i) => {
            headHTML += `<th>${day} • ${weekDays[i].toLocaleDateString(undefined, {month:'short', day:'numeric'})}</th>`;
        });
        timesheetHead.innerHTML = headHTML;

        // Build Body
        if (!tasks || tasks.length === 0) {
            timesheetBody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 20px;">No projects assigned to this user.</td></tr>`;
            return;
        }
        
        let bodyHTML = '';
        tasks.forEach(task => {
            bodyHTML += `<tr data-task-id="${task.id}">`;
            bodyHTML += `<td class="proj-cell">${task.name}</td>`;
            for (let i = 0; i < 5; i++) {
                bodyHTML += `<td><input type="number" class="num" step="0.25" min="0" placeholder="0.00"></td>`;
            }
            bodyHTML += `</tr>`;
        });
        timesheetBody.innerHTML = bodyHTML;
    }
    
    function getWeekDays() {
        const today = new Date();
        const dayOfWeek = (today.getDay() + 6) % 7;
        const monday = new Date(today);
        monday.setDate(today.getDate() - dayOfWeek);
        const days = [];
        for (let i = 0; i < 5; i++) {
            const day = new Date(monday);
            day.setDate(monday.getDate() + i);
            days.push(day);
        }
        return days;
    }

    // --- START THE APP ---
    init();

</script>
</body>
</html>